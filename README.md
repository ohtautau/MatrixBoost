# MatrixBoost

MatrixBoost 是一个高性能矩阵乘法优化与性能分析工具，支持多种矩阵乘法实现方式，并结合 CPU 性能事件统计和数据可视化工具，为用户提供矩阵运算的性能分析结果。

## 项目特性

- **多种矩阵乘法实现**：支持不同排列方式的矩阵乘法方法，如 `ikj`、`ijk` 等，以及 SIMD 优化版本。
- **CPU 性能事件监控**：通过 `perf` 工具收集运行时性能事件数据，如 L1/L2 缓存未命中率、指令数、分支预测失败等。
- **自定义 CPU 亲和性**：支持绑定到指定 CPU 核心运行以分析性能。
- **结果可视化**：生成矩阵运算性能指标的柱状图和折线图，便于分析和对比。

---

## 安装与依赖

### 系统要求

- Linux 操作系统（需要 `perf` 工具支持）。
- 已安装 GCC 编译器。

### 依赖库

使用以下命令安装 Python 依赖库：

```bash
pip install pandas matplotlib
```

---

## 使用方法

### 1. 编译并运行矩阵乘法

运行以下命令启动矩阵乘法的性能测试与数据收集：

```bash
python3 metrics.py
```

- **代码文件夹**：矩阵乘法实现文件位于 `src` 目录中。
- **性能结果**：运行后，性能指标将被存储到 `metrics` 文件夹内的 CSV 文件中。

### 2. 可视化性能指标

运行以下命令生成性能指标图表：

```bash
python3 charts.py
```

- **输入数据**：`metrics` 文件夹中生成的 CSV 文件。
- **输出图表**：图表将被保存到 `plots` 文件夹。

---

## 文件结构

```
MatrixBoost/
├── src/                        # 矩阵乘法实现源码
│   ├── mat_mul_ikj.c
│   ├── mat_mul_ijk.c
│   ├── mat_mul_kij.c
│   ├── mat_mul_jik.c
│   ├── mat_mul_jki.c
│   ├── mat_mul_kji.c
│   └── mat_mul_ijk_simd.c      # SIMD 优化版本
├── metrics/                    # 性能指标 CSV 文件（运行后生成）
├── plots/                      # 性能对比图表（运行后生成）
├── metrics.py                  # 运行矩阵乘法性能测试的主脚本
├── charts.py                   # 数据可视化脚本
└── README.md                   # 项目说明文件
```

---

## 配置与扩展

### 配置矩阵方法和参数

在 `metrics.py` 的 `methods` 字典中配置矩阵乘法方法的编译选项和 CPU 核心：

```python
methods = {
    "mat_mul_ikj": {"compile_options": "", "core_id": 0},
    "mat_mul_ijk_simd": {"compile_options": "-mavx2", "core_id": None},
}
```

- **`compile_options`**：指定编译选项（如启用 SIMD 的 `-mavx2`）。
- **`core_id`**：绑定到特定 CPU 核心（`None` 表示不绑定）。

---

## 示例输出

### 性能指标表格

运行矩阵乘法后生成的 `metrics/mat_mul_ikj_results.csv` 示例：

| Method           | Average Execution Time (s) | mem_load_retired.l1_miss | l2_rqsts.miss | LLC-load-misses | cache-misses | instructions |    branches |      cycles | context-switches |
| :--------------- | -------------------------: | -----------------------: | ------------: | --------------: | -----------: | -----------: | ----------: | ----------: | ---------------: |
| mat_mul_ijk      |                   0.229255 |              5.85624e+06 |   6.54012e+06 |         9776.33 |       119142 |  5.76803e+09 | 1.27996e+08 | 1.29471e+09 |          3.33333 |
| mat_mul_ijk_simd |                   0.189017 |                   774327 |        285588 |            1200 |      97138.3 |  2.77061e+09 | 3.41853e+07 | 1.06346e+09 |          2.66667 |
| mat_mul_ikj      |                   0.203979 |                   824732 |   7.32661e+06 |         3039.67 |       185588 |  5.76782e+09 | 1.27969e+08 | 1.10441e+09 |          2.33333 |
| mat_mul_jik      |                   0.216627 |              1.63448e+06 |   8.46588e+06 |            2861 |       159021 |  5.76789e+09 |  1.2798e+08 | 1.21413e+09 |                5 |
| mat_mul_jki      |                   0.271232 |              1.34467e+08 |   7.83909e+06 |           11484 |       122166 |   5.7683e+09 | 1.28047e+08 | 1.52715e+09 |          3.33333 |
| mat_mul_kij      |                   0.200623 |                   841982 |   7.87503e+06 |         2112.67 |       129364 |  5.76784e+09 | 1.27969e+08 | 1.12475e+09 |                2 |
| mat_mul_kji      |                   0.268089 |              1.29385e+08 |   7.06033e+06 |            5132 |        76183 |  5.76834e+09 | 1.28053e+08 | 1.51199e+09 |                3 |

### 性能对比图表

生成的图表位于 `plots` 文件夹，示例如下：

- **Bar 图**：各矩阵方法的 L1 缓存未命中率对比。
- **Line 图**：执行时间的趋势对比。

---

## 常见问题

等你发现